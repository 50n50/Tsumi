name: Auto Label Issues

on:
  issues:
    types: [opened, edited]

jobs:
  label-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Label Bug Severity
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;
            const labels = context.payload.issue.labels.map(label => label.name);
            
            // Only process if this is a bug report
            if (!labels.includes('bug')) {
              console.log('Not a bug report, skipping severity labeling');
              return;
            }
            
            // Define severity labels
            const severityLabels = [
              'severity: critical',
              'severity: high',
              'severity: medium',
              'severity: low'
            ];
            
            // Remove existing severity labels
            const labelsToRemove = labels.filter(label => severityLabels.includes(label));
            
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number,
                  name: label
                });
              } catch (error) {
                console.log(`Label ${label} not found or already removed`);
              }
            }
            
            // Determine new severity label
            let newLabel = null;
            if (body.includes('Critical - App is unusable')) {
              newLabel = 'severity: critical';
            } else if (body.includes('High - Major feature broken')) {
              newLabel = 'severity: high';
            } else if (body.includes('Medium - Feature works but with issues')) {
              newLabel = 'severity: medium';
            } else if (body.includes('Low - Minor inconvenience')) {
              newLabel = 'severity: low';
            }
            
            // Add new severity label
            if (newLabel) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: [newLabel]
              });
              console.log(`Added label: ${newLabel}`);
            }

      - name: Label Feature Priority
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;
            const labels = context.payload.issue.labels.map(label => label.name);
            
            // Only process if this is a feature request
            if (!labels.includes('enhancement')) {
              console.log('Not a feature request, skipping priority labeling');
              return;
            }
            
            // Define priority labels
            const priorityLabels = [
              'priority: critical',
              'priority: high',
              'priority: medium',
              'priority: low'
            ];
            
            // Remove existing priority labels
            const labelsToRemove = labels.filter(label => priorityLabels.includes(label));
            
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number,
                  name: label
                });
              } catch (error) {
                console.log(`Label ${label} not found or already removed`);
              }
            }
            
            // Determine new priority label
            let newLabel = null;
            if (body.includes('Critical - Prevents me from using the app effectively')) {
              newLabel = 'priority: critical';
            } else if (body.includes('High - Would significantly improve my experience')) {
              newLabel = 'priority: high';
            } else if (body.includes('Medium - Nice to have, would use occasionally')) {
              newLabel = 'priority: medium';
            } else if (body.includes('Low - Minor improvement')) {
              newLabel = 'priority: low';
            }
            
            // Add new priority label
            if (newLabel) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: [newLabel]
              });
              console.log(`Added label: ${newLabel}`);
            }